<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>G.R.I.D | Tactical Ops</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
:root {
  --neon: #00ff41;
  --bg-dark: #0e0e0e;
  --panel-bg: rgba(5,5,5,0.92);
  --font: 'Courier New', monospace;
  --ai-blue: #00a2ff;
}

html, body {
  margin:0; padding:0; height:100%; background:var(--bg-dark);
  font-family:var(--font); color:var(--neon); overflow:hidden;
}

/* Binary background overlay */
.binary {
  position:absolute; inset:0; z-index:0; color: rgba(0,255,65,0.03);
  font-size:14px; white-space: pre; line-height:18px; pointer-events:none;
}

/* Top nav */
.topbar {
  position:absolute; top:0; left:0; width:100%; height:50px;
  display:flex; justify-content:center; align-items:center;
  background:var(--bg-dark); border-bottom:1px solid rgba(0,255,65,0.2); z-index:1000;
}
.topbar .logo { font-weight:bold; letter-spacing:8px; font-size: 1.2rem; }

/* Map */
#map { position:absolute; top:50px; left:0; right:0; bottom:0; z-index:1; }

/* Floating panel */
.info-panel {
  position:absolute; top:70px; left:20px; width:360px; 
  height: auto; 
  max-height: 85vh;
  background:var(--panel-bg); border-radius:20px; border:1px solid rgba(0,255,65,0.3);
  padding:20px; overflow-y:auto; z-index:1000; box-shadow:0 0 25px rgba(0,255,65,0.1);
  transition: transform 0.3s ease, opacity 0.3s ease;
}

.info-panel.hidden {
  transform: translateX(-400px);
  opacity: 0;
  pointer-events: none;
}

.info-panel h3 { margin-top:0; border-bottom:1px solid rgba(0,255,65,0.2); padding-bottom:8px; font-size:1rem; display: flex; justify-content: space-between; align-items: center; }
.close-btn { cursor: pointer; font-size: 0.8rem; border: 1px solid var(--neon); padding: 2px 5px; }

/* Second floating panel for local intel */
#suspicious-box {
  left: auto;
  right: 20px;
  width: 300px;
  border-color: #ff0044;
  box-shadow: 0 0 25px rgba(255,0,68,0.1);
  transform: translateX(0);
}
#suspicious-box.hidden {
  transform: translateX(400px);
}
#suspicious-box h3 {
  border-bottom: 1px solid rgba(255,0,68,0.3);
  color: #ff0044;
}
#suspicious-box .close-btn {
  border-color: #ff0044;
}

/* AI UI Elements */
.ai-box {
  margin: 15px 0;
  padding: 15px;
  border: 1px solid var(--ai-blue);
  background: rgba(0, 162, 255, 0.05);
  border-radius: 10px;
}
.ai-header {
  font-size: 0.6rem;
  color: var(--ai-blue);
  letter-spacing: 2px;
  margin-bottom: 10px;
  display: flex;
  justify-content: space-between;
}
.scan-bar-container {
  height: 2px;
  background: rgba(0, 162, 255, 0.2);
  width: 100%;
  margin-bottom: 10px;
}
.scan-bar {
  height: 100%;
  background: var(--ai-blue);
  width: 0%;
  box-shadow: 0 0 10px var(--ai-blue);
  transition: width 0.05s linear;
}
.ai-text {
  font-size: 0.7rem;
  line-height: 1.4;
  color: #c0eaff;
  min-height: 30px;
}
.risk-meter {
  height: 4px;
  background: #222;
  margin-top: 10px;
  border-radius: 2px;
  overflow: hidden;
}
.risk-fill { height: 100%; width: 0%; transition: width 1s ease-in-out; }

/* RECON STYLING */
.recon-controls {
  padding: 10px;
  border: 1px solid rgba(0,255,65,0.2);
  margin-bottom: 15px;
  border-radius: 10px;
}
.recon-input {
  width: 100%;
  background: #000;
  border: 1px solid var(--neon);
  color: var(--neon);
  padding: 5px;
  font-family: var(--font);
  font-size: 0.7rem;
  margin-top: 5px;
  box-sizing: border-box;
}
.recon-btn {
  width: 100%;
  background: rgba(0,162,255,0.1);
  border: 1px solid var(--ai-blue);
  color: var(--ai-blue);
  padding: 8px;
  margin-top: 10px;
  cursor: pointer;
  font-family: var(--font);
  font-size: 0.7rem;
  transition: 0.2s;
  box-sizing: border-box;
}
.recon-btn:hover { background: var(--ai-blue); color: #000; }
.recon-btn.red { border-color: #ff0044; color: #ff0044; }
.recon-btn.red:hover { background: #ff0044; color: #000; }

/* Camera UI */
#camera-container { width: 100%; margin-top: 10px; display: none; position: relative; border: 1px solid var(--neon); }
#video-feed { width: 100%; height: auto; display: block; filter: sepia(100%) hue-rotate(90deg) brightness(1.2); }
#canvas-hidden { display: none; }

/* Google Earth Button Style */
.geo-btn {
  display: block;
  margin-top: 15px;
  padding: 10px;
  text-align: center;
  border: 1px solid var(--neon);
  color: var(--neon);
  text-decoration: none;
  font-size: 0.7rem;
  transition: background 0.2s;
}
.geo-btn:hover { background: rgba(0,255,65,0.1); }

#openPanel {
  position: absolute; top: 70px; left: 20px; z-index: 999; 
  background: var(--bg-dark); border: 1px solid var(--neon); color: var(--neon);
  padding: 10px; cursor: pointer; font-family: var(--font); font-size: 0.7rem;
}

.row { display:flex; justify-content:space-between; font-size:0.75rem; margin-bottom:5px; }
.label { opacity:0.6; }

.leaflet-tooltip { background:#000; border:1px solid var(--neon); color:var(--neon); font-size:10px; padding:2px 6px; border-radius:4px; }

#coords { position:absolute; bottom:10px; right:20px; font-size:10px; opacity:0.6; z-index:1000; }
</style>
</head>
<body>

<div class="binary" id="binary-bg"></div>

<div class="topbar">
  <div class="logo">G.R.I.D</div>
</div>

<div id="map"></div>

<button id="openPanel" style="display:none;">[ SHOW PANEL ]</button>

<div class="info-panel" id="panel">
  <h3>
    <span>ACTIVE SURVEILLANCE NODE</span>
    <span class="close-btn" onclick="togglePanel()">[X]</span>
  </h3>

  <div class="recon-controls">
    
    <div style="font-size: 0.6rem; color: var(--neon); margin-top: 10px;">[ VISION SCAN ]</div>
    <input type="file" id="reconUpload" class="recon-input" accept="image/*">

    <div style="font-size: 0.6rem; color: var(--neon); margin-top: 15px;">[ LIVE OPTICS (LOCATION RECON) ]</div>
    <button class="recon-btn" id="startCamBtn">[ OPEN REAR CAMERA UPLINK ]</button>
    <div id="camera-container">
        <video id="video-feed" autoplay playsinline></video>
        <button class="recon-btn red" id="captureBtn">CAPTURE & LOCATE FRAME</button>
    </div>
    <canvas id="canvas-hidden"></canvas>
    
    <button class="recon-btn" id="localScanBtn" style="margin-top: 15px;">[ SCAN MY DEVICE LOCATION ]</button>
    <div id="reconStatus" style="font-size: 0.6rem; margin-top: 5px; color: yellow; display: none; line-height: 1.4;">STANDBY...</div>
  </div>

  <div id="panelContent">
    <div class="row"><span class="label">STATUS</span><span>GLOBAL MONITORING ACTIVE</span></div>
    <div class="row"><span class="label">UPLINK</span><span>STABLE — ENCRYPTED</span></div>
    <div class="row"><span class="label">THREAT LEVEL</span><span>ELEVATED</span></div>
  </div>
</div>

<div id="suspicious-box" class="info-panel hidden">
    <h3>
      <span>[ LOCAL INTEL ]</span>
      <span class="close-btn" onclick="document.getElementById('suspicious-box').classList.add('hidden')">[X]</span>
    </h3>
    <div id="suspicious-content" style="font-size: 0.75rem; color: #ff0044; line-height: 1.5; font-weight: bold;">
        AWAITING INTEL...
    </div>
</div>

<div id="coords">LAT: 0 | LNG: 0</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const neon="#00ff41";

const nodes=[
  {id:"N-01", name:"Lukas Reinhardt", city:"Berlin, Germany", lat:52.52, lng:13.405, weapon:"HK416 A5", caliber:"5.56 NATO", recoil:"1.8° vertical", lastFire:"2026-02-14 21:43 UTC", status:"ACTIVE FIELD DEPLOYMENT", bio:"Former tactical specialist. Cross-border monitored."},
  {id:"N-02", name:"Akira Tanaka", city:"Tokyo, Japan", lat:35.6895, lng:139.6917, weapon:"Type 20 Rifle", caliber:"5.56mm", recoil:"1.5° compensated", lastFire:"2026-02-17 03:12 UTC", status:"SURVEILLANCE MODE", bio:"Private security contractor. Structured range cycles."},
  {id:"N-03", name:"Ethan Hunt", city:"New York, USA", lat:40.7128, lng:-74.006, weapon:"AR-15", caliber:".223 Remington", recoil:"2.1° rapid", lastFire:"2026-02-10 18:05 UTC", status:"LOW ACTIVITY", bio:"Civilian licensed owner. No anomalies."},
  {id:"N-04", name:"Sofia Petrova", city:"Moscow, Russia", lat:55.7558, lng:37.6173, weapon:"AK-12", caliber:"5.45x39mm", recoil:"2.5° unmitigated", lastFire:"2026-02-12 14:30 UTC", status:"ACTIVE FIELD DEPLOYMENT", bio:"Former military operative. Elevated activity detected."},
  {id:"N-05", name:"Carlos Mendez", city:"Mexico City, Mexico", lat:19.4326, lng:-99.1332, weapon:"SIG MCX", caliber:"5.56 NATO", recoil:"1.7° controlled", lastFire:"2026-02-15 20:20 UTC", status:"SURVEILLANCE MODE", bio:"Licensed enthusiast. Regular range visits."},
  {id:"N-06", name:"Amina Al-Farsi", city:"Dubai, UAE", lat:24.4539, lng:54.3773, weapon:"Tavor X95", caliber:"5.56 NATO", recoil:"1.6° balanced", lastFire:"2026-02-18 01:45 UTC", status:"LOW ACTIVITY", bio:"Private security consultant. No recent anomalies."},
  {id:"N-07", name:"Liam O'Connor", city:"Dublin, Ireland", lat:53.3498, lng:-6.2603, weapon:"FN SCAR-L", caliber:"5.56 NATO", recoil:"1.9° moderate", lastFire:"2026-02-11 19:55 UTC", status:"ACTIVE FIELD DEPLOYMENT", bio:"Former special forces. Elevated activity detected."},
  {id:"N-08", name:"Isabella Rossi", city:"Rome, Italy", lat:41.9028, lng:12.4964, weapon:"Beretta ARX160", caliber:"5.56 NATO", recoil:"1.8° controlled", lastFire:"2026-02-13 17:40 UTC", status:"SURVEILLANCE MODE", bio:"Licensed owner. Regular range visits."},
  {id:"N-09", name:"Chen Wei", city:"Shanghai, China", lat:31.2304, lng:121.4737, weapon:"QBZ-95", caliber:"5.8mm", recoil:"2.0° unmitigated", lastFire:"2026-02-16 22:10 UTC", status:"LOW ACTIVITY", bio:"Civilian licensed owner. No anomalies."},
  {id:"N-10", name:"Sven Larsson", city:"Stockholm, Sweden", lat:59.3293, lng:18.0686, weapon:"AK5C", caliber:"5.56 NATO", recoil:"1.7° balanced", lastFire:"2026-02-14 20:25 UTC", status:"ACTIVE FIELD DEPLOYMENT", bio:"Former military operative. Elevated activity detected."},
  {id:"N-11", name:"Maria Silva", city:"São Paulo, Brazil", lat:-23.5505, lng:-46.6333, weapon:"IMBEL IA2", caliber:"5.56 NATO", recoil:"1.9° moderate", lastFire:"2026-02-17 18:50 UTC", status:"SURVEILLANCE MODE", bio:"Licensed enthusiast. Regular range visits."},
  {id:"N-12", name:"David Kim", city:"Seoul, South Korea", lat:37.5665, lng:126.978, weapon:"Daewoo K2", caliber:"5.56 NATO", recoil:"1.8° controlled", lastFire:"2026-02-12 16:30 UTC", status:"LOW ACTIVITY", bio:"Civilian licensed owner. No anomalies."},
  {id:"N-13", name:"Fatima Hassan", city:"Cairo, Egypt", lat:30.0444, lng:31.2357, weapon:"Misr Assault Rifle", caliber:"5.56 NATO", recoil:"1.9° moderate", lastFire:"2026-02-15 19:15 UTC", status:"ACTIVE FIELD DEPLOYMENT", bio:"Former tactical specialist. Cross-border monitored."},
  {id:"N-14", name:"Ahmed Al-Mansoori", city:"Abu Dhabi, UAE", lat:24.4667, lng:54.3667, weapon:"M16A4", caliber:"5.56 NATO", recoil:"1.8° controlled", lastFire:"2026-02-18 09:30 UTC", status:"SURVEILLANCE MODE", bio:"Private security consultant. No recent anomalies."},
  {id:"N-15", name:"Jeffrey Epstein", city:"Epstein Island, USA", lat:42.8417, lng:-120.9375, weapon:"AK-47", caliber:"7.62×39mm", recoil:"2.5 unmitigated", lastFire:"2026-02-15 19:15 UTC", status:"HIGH ACTIVITY", bio:"Criminal mastermind. Elevated activity detected."}
];

const map=L.map('map',{
  zoomControl:false, 
  attributionControl:false,
  minZoom: 2,
  maxBounds: [[-90, -180], [90, 180]]
}).setView([25,0],2.2);

L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{
  attribution:'©OpenStreetMap ©CartoDB'
}).addTo(map);

nodes.forEach(n=>{
  const marker=L.circleMarker([n.lat,n.lng],{
    radius:7, color:neon, fillColor:"#000", fillOpacity:1, weight:2
  }).addTo(map);

  marker.bindTooltip(`${n.name} — ${n.city}`, {permanent:true, direction:"top", offset:[0,-10]});

  marker.on("click",()=>{
      if(document.getElementById("panel").classList.contains("hidden")) togglePanel();
      updatePanel(n);
  });
});

// ==========================================
// VISION SCANNER (IMAGE UPLOAD)
// ==========================================
const reconUpload = document.getElementById('reconUpload');
const reconStatus = document.getElementById('reconStatus');

reconUpload.onchange = async () => {
    const file = reconUpload.files[0];
    if(!file) return;

    reconStatus.style.display = 'block';
    reconStatus.innerText = "PARSING INTEL...";

    const mimeType = file.type; 
    const base64 = await new Promise((resolve) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result.split(',')[1]);
        reader.readAsDataURL(file);
    });

    try {
        const response = await fetch(`http://localhost:3000/api/gemini`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [
                    { text: "Identify the school name, building name, or specific landmark in this image. Return ONLY the name and the city. No other text." },
                    { inline_data: { mime_type: mimeType, data: base64 } }
                ] }]
            })
        });

        const data = await response.json();
        if(data.error) {
            reconStatus.innerText = `API ERROR: ${data.error.message}`;
            return;
        }

        const foundPlace = data.candidates[0].content.parts[0].text.trim();
        if (foundPlace && foundPlace !== "Unknown") {
            reconStatus.innerText = `LOCK ON: ${foundPlace}`;
            const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(foundPlace)}`);
            const geoData = await geoRes.json();
            
            if (geoData.length > 0) {
                const { lat, lon } = geoData[0];
                map.flyTo([lat, lon], 16);
                L.circleMarker([lat, lon], { color: '#00a2ff', radius: 10 }).addTo(map)
                  .bindPopup(`<b>AI LOCK:</b> ${foundPlace}`).openPopup();
            }
        }
    } catch (err) {
        reconStatus.innerText = `UPLINK ERROR: Check console for details.`;
        console.error(err);
    }
};

// ==========================================
// LIVE CAMERA UPLINK (BACK CAM GEOLOCATION)
// ==========================================
const video = document.getElementById('video-feed');
const canvas = document.getElementById('canvas-hidden');
const camContainer = document.getElementById('camera-container');
const startCamBtn = document.getElementById('startCamBtn');

startCamBtn.onclick = async () => {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        video.srcObject = stream;
        camContainer.style.display = 'block';
        startCamBtn.style.display = 'none';
    } catch (err) { 
        reconStatus.style.display = 'block';
        reconStatus.innerText = "REAR CAMERA HARDWARE DENIED OR UNAVAILABLE."; 
    }
};

document.getElementById('captureBtn').onclick = async () => {
    reconStatus.style.display = 'block';
    reconStatus.innerText = "UPLOADING LIVE FRAME FOR GEOLOCATION...";

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    const dataUrl = canvas.toDataURL('image/jpeg');
    const base64Data = dataUrl.split(',')[1];

    try {
        const response = await fetch(`http://localhost:3000/api/gemini`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [
                    { text: "Identify the specific location, building name, landmark, or city in this image. Return ONLY the name. No other text." },
                    { inline_data: { mime_type: 'image/jpeg', data: base64Data } }
                ] }]
            })
        });

        const data = await response.json();
        if(data.error) {
            reconStatus.innerText = `API ERROR: ${data.error.message}`;
            return;
        }

        const foundPlace = data.candidates[0].content.parts[0].text.trim();
        reconStatus.innerText = `OPTICS LOCK ON: ${foundPlace}`;

        if (foundPlace && foundPlace !== "Unknown") {
            const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(foundPlace)}`);
            const geoData = await geoRes.json();
            
            if (geoData.length > 0) {
                const { lat, lon } = geoData[0];
                map.flyTo([lat, lon], 16);
                L.circleMarker([lat, lon], { color: '#ff0044', radius: 10 }).addTo(map)
                  .bindPopup(`<b>LIVE CAM LOCK:</b> ${foundPlace}`).openPopup();
            }
        }
    } catch (err) {
        reconStatus.innerText = `UPLINK ERROR: Check console for details.`;
        console.error(err);
    }
};

// ==========================================
// GPS LOCAL SIMULATION SCAN (FLOATING BOX)
// ==========================================
document.getElementById('localScanBtn').onclick = () => {
    if (navigator.geolocation) {
        reconStatus.style.display = 'block';
        reconStatus.innerText = "ACQUIRING DEVICE GPS...";
        
        navigator.geolocation.getCurrentPosition(async (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            map.flyTo([lat, lng], 14);
            
            const locIcon = L.divIcon({
                html: '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#ff0044" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>',
                className: 'custom-loc-icon',
                iconSize: [28, 28],
                iconAnchor: [14, 28] 
            });
            L.marker([lat, lng], {icon: locIcon}).addTo(map);

            try {
                reconStatus.innerText = "GPS LOCKED. SIMULATING TACTICAL REPORT...";
                const geoRes = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                const geoData = await geoRes.json();
                const locationName = geoData.address.city || geoData.address.town || "Unknown Sector";

                const prompt = `Act as a G.R.I.D. tactical surveillance AI. The user's device is located in ${locationName}. Generate a fictional, cyberpunk-style 2-sentence tactical status report simulating a scan for suspicious activity or threats in that specific city. Do not mention that it is fictional in the output.`;

                const aiRes = await fetch(`http://localhost:3000/api/gemini`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const aiData = await aiRes.json();
                if(aiData.error) {
                    reconStatus.innerText = `API ERROR: ${aiData.error.message}`;
                } else {
                    const reportText = aiData.candidates[0].content.parts[0].text;
                    reconStatus.innerText = "LOCAL INTEL ACQUIRED.";
                    document.getElementById('suspicious-content').innerText = reportText;
                    document.getElementById('suspicious-box').classList.remove('hidden');
                }
            } catch (err) {
                reconStatus.innerText = "ERROR FETCHING LOCAL INTEL.";
            }

        }, (error) => {
            reconStatus.style.display = 'block';
            reconStatus.innerText = "GPS DENIED BY USER.";
        });
    } else {
        alert("Geolocation is not supported by this browser.");
    }
};

// ==========================================
// AI NEURAL ANALYSIS (RESTORED API INTEGRATION)
// ==========================================
async function runNeuralAnalysis(n) {
    const aiText = document.getElementById('aiOutput');
    const scanBar = document.getElementById('scanBar');
    
    aiText.innerText = "INITIALIZING NEURAL LINK...";
    scanBar.style.width = "50%";
    
    // Calculate simulated risk score
    const recoilVal = parseFloat(n.recoil) || 0;
    const riskScore = Math.min(100, Math.floor((recoilVal * 25) + (n.status.includes("ACTIVE") ? 35 : 5)));
    
    document.getElementById('riskScoreDisplay').innerText = riskScore + "%";
    const riskFill = document.getElementById('riskFill');
    riskFill.style.width = riskScore + "%";
    riskFill.style.background = riskScore > 75 ? "#ff0044" : (riskScore > 45 ? "#ffcc00" : "#00ff41");

    // Live AI Generative Profiling
    try {
        const prompt = `Act as G.R.I.D, an advanced cyberpunk tactical surveillance AI. Analyze the following target data:
        Name: ${n.name}
        Location: ${n.city}
        Weapon: ${n.weapon}
        Status: ${n.status}
        Background: ${n.bio}
        Threat Level: ${riskScore}%
        Provide a brief, intense, 2-sentence tactical threat assessment. Do not mention you are an AI. Sound cold, calculated, and strictly analytical.`;

        const aiRes = await fetch(`http://localhost:3000/api/gemini`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });

        const aiData = await aiRes.json();
        scanBar.style.width = "100%";
        
        if (aiData.error) {
            throw new Error(aiData.error.message); // Throw to trigger offline fallback
        } else {
            const reportText = aiData.candidates[0].content.parts[0].text;
            aiText.innerText = reportText;
        }
    } catch (err) {
        // Fallback to offline mode if local proxy is down or throws an error
        const responses = [
            "SUBJECT DISPLAYS ERRATIC BEHAVIORAL PATTERNS. RECOMMEND INCREASED SURVEILLANCE.",
            "WEAPONRY SIGNATURE REMAINS DORMANT. NO IMMEDIATE TACTICAL THREAT DETECTED.",
            "BIOMETRICS INDICATE ELEVATED STRESS LEVELS. POTENTIAL FLIGHT RISK.",
            "COMMUNICATION UPLINK INTERCEPTED. TARGET IS COORDINATING WITH UNKNOWN ENTITIES.",
            "ROUTINE MOVEMENT DETECTED. SECTOR REMAINS CLEAR FOR NOW.",
            "ANOMALOUS BALLISTICS DATA RECORDED IN PREVIOUS 48 HOURS. FLAG FOR REVIEW."
        ];
        
        setTimeout(() => {
            scanBar.style.width = "100%";
            let chosenResponse = responses[Math.floor(Math.random() * responses.length)];
            if (riskScore > 75) {
                chosenResponse = "CRITICAL: HIGH PROBABILITY OF HOSTILE ACTION. PREPARE COUNTERMEASURES.";
            } else if (riskScore < 30) {
                chosenResponse = "TARGET PACIFIED. NO SIGNIFICANT DEVIATIONS FROM BASELINE.";
            }
            aiText.innerText = `[OFFLINE MODE] ${chosenResponse}`;
        }, 800);
    }
}

function updatePanel(n){
  const earthUrl = `https://earth.google.com/web/@${n.lat},${n.lng},1000d`;
  
  document.getElementById("panelContent").innerHTML=`
  <div class="row"><span class="label">ID</span><span>${n.id}</span></div>
  <div class="row"><span class="label">NAME</span><span>${n.name}</span></div>
  <div class="row"><span class="label">LOCATION</span><span>${n.city}</span></div>
  <div class="row"><span class="label">STATUS</span><span>${n.status}</span></div>
  
  <div class="ai-box">
    <div class="ai-header">
      <span>G.R.I.D NEURAL ENGINE</span>
      <span id="riskScoreDisplay">0%</span>
    </div>
    <div class="scan-bar-container"><div class="scan-bar" id="scanBar"></div></div>
    <div class="ai-text" id="aiOutput">AWAITING TARGET SELECTION...</div>
    <div class="risk-meter"><div class="risk-fill" id="riskFill"></div></div>
  </div>

  <div class="row"><span class="label">WEAPON</span><span>${n.weapon}</span></div>
  <div class="row"><span class="label">RECOIL</span><span>${n.recoil}</span></div>
  <div style="margin-top:10px;font-size:0.7rem;opacity:0.7;">${n.bio}</div>
  <a href="${earthUrl}" target="_blank" class="geo-btn">OPEN GEOSPATIAL FEED</a>
  `;

  setTimeout(() => runNeuralAnalysis(n), 100);
}

function togglePanel() {
    const panel = document.getElementById("panel");
    const openBtn = document.getElementById("openPanel");
    if(panel.classList.contains("hidden")) {
        panel.classList.remove("hidden");
        openBtn.style.display = "none";
    } else {
        panel.classList.add("hidden");
        openBtn.style.display = "block";
    }
}

document.getElementById("openPanel").onclick = togglePanel;

map.on("mousemove", function(e){
  document.getElementById("coords").innerText=
  `LAT: ${e.latlng.lat.toFixed(4)} | LNG: ${e.latlng.lng.toFixed(4)}`;
});

const binary = document.getElementById('binary-bg');
function generateBinary() {
  const rows = [];
  for(let i=0;i<50;i++){
    let line = '';
    for(let j=0;j<120;j++){
      line += Math.random() > 0.5 ? '1' : '0';
    }
    rows.push(line);
  }
  binary.textContent = rows.join('\n');
}
setInterval(generateBinary, 100);
</script>
</body>
</html>